steps: 
  - script: $HOME/.poetry/bin/poetry run pytest --junitxml=junit/test-results.xml --cov-report=xml
    env:
      FORESHADOW_TESTS: ALL
    displayName: Run pytest
  # TODO: Switch back to 'Linux' when https://github.com/sdispater/poetry/issues/1197 is resolved
  - script: $HOME/.poetry/bin/poetry run coveralls
    condition: and(succeeded(), eq( variables['Agent.OS'], 'Darwin' ))
    env:
      COVERALLS_REPO_TOKEN: $(coveralls_token)
    displayName: Submit coveralls report
  - task: PublishTestResults@2
    inputs:
      testResultsFiles: 'junit/test-results.xml'
      testRunTitle: '$(Agent.OS) - $(Build.BuildNumber)[$(Agent.JobName)] - Python $(python.version)'
    condition: succeededOrFailed()
  - task: PublishCodeCoverageResults@1
    inputs:
      codeCoverageTool: Cobertura
      summaryFileLocation: '$(System.DefaultWorkingDirectory)/**/coverage.xml'
      reportDirectory: '$(System.DefaultWorkingDirectory)/**/htmlcov'
  - task: BuildQualityChecks@6
    inputs:
      checkCoverage: true
      coverageFailOption: 'fixed'
      coverageType: 'branches'
      coverageThreshold: '90'
      runTitle: 'Check coverage level'